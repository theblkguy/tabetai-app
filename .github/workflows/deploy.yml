name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      SPOONACULAR_API_KEY: ${{ secrets.SPOONACULAR_API_KEY }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate required secrets (TEMPORARILY DISABLED)
      run: |
        echo "âœ… Skipping validation for now - deploying with available secrets"
        echo "EC2_HOST: ${EC2_HOST:+SET}"
        echo "EC2_USER: ${EC2_USER:+SET}"  
        echo "EC2_SSH_KEY: ${EC2_SSH_KEY:+SET}"
        echo "MONGODB_URI: ${MONGODB_URI:+SET}"
        echo "SPOONACULAR_API_KEY: ${SPOONACULAR_API_KEY:+SET}"
        echo "GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:+SET}"
        echo "âœ… Proceeding with deployment!"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install root dependencies
      run: npm install

    - name: Install client dependencies
      run: |
        cd client
        npm install

    - name: Install backend dependencies
      run: |
        cd backend
        npm install

    - name: Create client .env file
      run: |
        cd client
        echo "REACT_APP_GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" > .env
        echo "REACT_APP_SPOONACULAR_API_KEY=$SPOONACULAR_API_KEY" >> .env

    - name: Build client
      run: npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy
        # Copy backend files
        cp -r backend/* deploy/
        # Copy built frontend files
        mkdir -p deploy/public
        cp -r client/dist/* deploy/public/
        # Copy root package.json for any shared dependencies
        cp package.json deploy/package-root.json

    - name: Create backend .env file in deployment
      run: |
        cd deploy
        echo "MONGODB_URI=$MONGODB_URI" > .env
        echo "SPOONACULAR_API_KEY=$SPOONACULAR_API_KEY" >> .env
        echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
        echo "PORT=80" >> .env
        echo "NODE_ENV=production" >> .env

    - name: Create application archive
      run: |
        cd deploy
        zip -r ../deployment.zip . -x "node_modules/*" "*.git*"

    - name: Deploy to EC2
      run: |
        # Use environment variables (secrets are injected at job level)
        PRIVATE_KEY="$EC2_SSH_KEY"
        HOST="$EC2_HOST"
        USER="$EC2_USER"
        
        # Validate that secrets were properly injected
        echo "ðŸ” Validating secret injection:"
        if [ -z "$HOST" ]; then
          echo "âŒ Missing required secrets:"
          echo "EC2_HOST: 'NOT SET'"
          echo ""
          echo "Please ensure secrets are configured in repository settings:"
          echo "https://github.com/theblkguy/tabetai-app/settings/secrets/actions"
          exit 1
        fi
        if [ -z "$USER" ]; then
          echo "âŒ Missing required secrets:"
          echo "EC2_USER: 'NOT SET'"
          exit 1
        fi
        if [ -z "$PRIVATE_KEY" ]; then
          echo "âŒ Missing required secrets:"
          echo "EC2_SSH_KEY: 'NOT SET'"
          exit 1
        fi
        
        # Debug: Check if variables are set (without exposing content)
        echo "âœ… All secrets properly injected:"
        echo "HOST: ${HOST}"
        echo "USER: ${USER}"
        echo "SSH Key length: ${#PRIVATE_KEY} characters"
        
        # Create private key file
        echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
        
        # Copy deployment package to EC2
        scp -o StrictHostKeyChecking=no -i private_key deployment.zip ${USER}@${HOST}:~/
        
        # Deploy on EC2
        ssh -o StrictHostKeyChecking=no -i private_key ${USER}@${HOST} << 'EOF'
          # Create application directory
          mkdir -p ~/tabetai-app
          cd ~/tabetai-app
          
          # Stop existing application
          pm2 delete tabetai-app || true
          
          # Backup current deployment (if exists)
          if [ -d "current" ]; then
            rm -rf backup
            mv current backup
          fi
          
          # Extract new deployment
          mkdir -p current
          cd current
          unzip -o ~/deployment.zip
          
          # Install dependencies
          npm install --production
          
          # Install PM2 globally if not exists
          which pm2 || npm install -g pm2
          
          # Ensure PM2 is in PATH
          export PATH=$PATH:/usr/local/bin:$(npm bin -g)
          
          # Kill any existing processes on port 80
          sudo fuser -k 80/tcp || true
          
          # Stop and delete existing PM2 process
          pm2 delete tabetai-app || true
          
          # Wait for cleanup
          sleep 3
          
          # Start application with PM2
          NODE_ENV=production pm2 start server.js --name "tabetai-app"
          
          # Save PM2 configuration
          pm2 save
          
          # Setup PM2 startup script
          sudo pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
          
          # Clean up
          rm ~/deployment.zip
          
          echo "Deployment completed successfully!"
          echo "PM2 Status:"
          pm2 status
          echo "Application logs:"
          pm2 logs tabetai-app --lines 10
        EOF
        
        # Clean up local private key
        rm private_key

    - name: Verify Deployment
      run: |
        HOST="$EC2_HOST"
        echo "Waiting for application to start..."
        sleep 10
        echo "Testing connection to http://${HOST}:80/"
        curl -f http://${HOST}:80/ || echo "Warning: Health check failed, but deployment may still be successful"
